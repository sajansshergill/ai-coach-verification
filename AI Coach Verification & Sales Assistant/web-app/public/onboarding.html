<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Onboarding - AI Verification</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üë§ Coach Onboarding & Verification</h1>
            <nav>
                <a href="index.html">‚Üê Home</a>
                <a href="admin.html">Admin Dashboard</a>
            </nav>
        </header>

        <main class="onboarding-container">
            <!-- Step 1: Coach Info -->
            <div id="step1" class="step active">
                <h2>Step 1: Coach Information</h2>
                <div class="form-group">
                    <label for="coachName">Full Name *</label>
                    <input type="text" id="coachName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="coachEmail">Email Address *</label>
                    <input type="email" id="coachEmail" placeholder="your@email.com" required>
                </div>
                <button onclick="startOnboarding()" class="btn btn-primary" id="startBtn">
                    <span id="startBtnText">Start Verification</span>
                    <span id="startBtnLoader" class="hidden">Loading...</span>
                </button>
            </div>

            <!-- Step 2: AI Conversation -->
            <div id="step2" class="step hidden">
                <h2>Verification Conversation</h2>
                <div id="chatContainer" class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Type your message..." 
                               onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                        <button onclick="sendMessage()" class="btn btn-primary" id="sendBtn">
                            <span>Send</span>
                        </button>
                    </div>
                </div>
                <div id="credentialsSummary" class="credentials-summary hidden">
                    <h3>Credentials Collected</h3>
                    <div id="credentialsList"></div>
                    <button onclick="generateTrustSummary()" class="btn btn-secondary">Generate Trust Summary</button>
                </div>
            </div>

            <!-- Step 3: Trust Summary -->
            <div id="step3" class="step hidden">
                <h2>Trust Profile Summary</h2>
                <div id="trustSummary" class="trust-summary-display">
                    <!-- Trust summary will appear here -->
                </div>
                <div class="actions">
                    <button onclick="regenerateSummary()" class="btn btn-secondary">Regenerate</button>
                    <button onclick="submitForReview()" class="btn btn-primary">Submit for Review</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentCoachId = null;
        let conversationStarted = false;

        async function startOnboarding() {
            const name = document.getElementById('coachName').value;
            const email = document.getElementById('coachEmail').value;

            if (!name || !email) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Show loading state
            const startBtn = document.getElementById('startBtn');
            const startBtnText = document.getElementById('startBtnText');
            const startBtnLoader = document.getElementById('startBtnLoader');
            startBtn.disabled = true;
            startBtnText.classList.add('hidden');
            startBtnLoader.classList.remove('hidden');

            try {
                // Create coach
                const response = await fetch('/api/coaches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                const coach = await response.json();
                currentCoachId = coach.id;

                // Move to step 2
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');

                // Start conversation
                await startConversation();
            } catch (error) {
                console.error('Error:', error);
                showToast('Error starting onboarding. Please try again.', 'error');
            } finally {
                // Reset button state
                startBtn.disabled = false;
                startBtnText.classList.remove('hidden');
                startBtnLoader.classList.add('hidden');
            }
        }

        async function startConversation() {
            if (!currentCoachId || conversationStarted) return;
            conversationStarted = true;

            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                addMessage('assistant', data.message);
                updateCredentialsDisplay(data.coach.credentials);
            } catch (error) {
                console.error('Error:', error);
                alert('Error starting conversation. Make sure OpenAI API key is configured.');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            input.value = '';
            
            // Disable input while processing
            input.disabled = true;
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="spinner"></span> Sending...';
            }
            
            // Show typing indicator
            const typingId = addMessage('assistant', '...');

            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                // Remove typing indicator
                const typingEl = document.getElementById(`msg-${typingId}`);
                if (typingEl) typingEl.remove();

                if (data.error) {
                    addMessage('error', `Error: ${data.error}`);
                    showToast(data.error, 'error');
                } else {
                    addMessage('assistant', data.message);
                    updateCredentialsDisplay(data.coach.credentials);
                    
                    // Show credentials summary if we have some
                    if (Object.keys(data.coach.credentials).length > 0) {
                        document.getElementById('credentialsSummary').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const typingEl = document.getElementById(`msg-${typingId}`);
                if (typingEl) typingEl.remove();
                addMessage('error', 'Error sending message. Please try again.');
                showToast('Unable to send message. Please check your connection.', 'error');
            } finally {
                // Re-enable input
                input.disabled = false;
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<span>Send</span>';
                }
                input.focus();
            }
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            const id = Date.now();
            messageDiv.id = `msg-${id}`;
            
            let roleLabel = 'AI Assistant';
            if (role === 'user') roleLabel = 'You';
            else if (role === 'error' || role === 'system') roleLabel = 'System';
            
            messageDiv.innerHTML = `
                <div class="message-role">${roleLabel}</div>
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return id;
        }
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateCredentialsDisplay(credentials) {
            const listDiv = document.getElementById('credentialsList');
            let html = '<ul>';
            
            if (credentials.certifications && credentials.certifications.length > 0) {
                html += `<li>‚úÖ Certifications: ${credentials.certifications.join(', ')}</li>`;
            }
            if (credentials.experience && credentials.experience.years) {
                html += `<li>‚úÖ Experience: ${credentials.experience.years} years</li>`;
            }
            if (credentials.website) {
                html += `<li>‚úÖ Website: ${credentials.website}</li>`;
            }
            if (credentials.linkedin) {
                html += `<li>‚úÖ LinkedIn: ${credentials.linkedin}</li>`;
            }
            if (credentials.testimonials && credentials.testimonials.length > 0) {
                html += `<li>‚úÖ Testimonials: ${credentials.testimonials.length}</li>`;
            }
            if (credentials.paymentVerified) {
                html += `<li>‚úÖ Payment Verified</li>`;
            }
            
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        async function generateTrustSummary() {
            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/generate-summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.error) {
                    showToast(`Error: ${data.error}`, 'error');
                } else {
                    showToast('Trust summary generated successfully!', 'success');
                    document.getElementById('trustSummary').innerHTML = 
                        `<div class="trust-summary-content">${data.summary.replace(/\n/g, '<br>')}</div>`;
                    
                    // Move to step 3
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('step3').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error generating summary. Please check console.');
            }
        }

        async function regenerateSummary() {
            await generateTrustSummary();
        }

        async function submitForReview() {
            try {
                const response = await fetch(`/api/coaches/${currentCoachId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'pending_review' })
                });

                if (response.ok) {
                    showToast('‚úÖ Profile submitted for review!', 'success');
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error submitting for review. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
