<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Onboarding & Verification</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>Coach Onboarding & Verification</h1>
            <nav>
                <a href="index.html">← Home</a>
                <a href="admin.html">Admin Dashboard</a>
            </nav>
        </header>

        <main class="onboarding-container">
            <!-- Step 1: Coach Basic Info -->
            <div id="step1" class="step active">
                <h2>Create Your Coach Profile</h2>
                <p class="step-description">Get started by providing your basic information. All data is encrypted and securely stored in compliance with GDPR and data protection regulations.</p>
                
                <div class="form-group">
                    <label for="coachName">Full Name *</label>
                    <input type="text" id="coachName" placeholder="Enter your full name" required>
                </div>
                
                <div class="form-group">
                    <label for="coachEmail">Email Address *</label>
                    <input type="email" id="coachEmail" placeholder="your@email.com" required>
                    <small class="form-help">We'll use this for account notifications and verification</small>
                </div>

                <!-- Privacy Notice -->
                <div class="privacy-notice">
                    <h4>Data Privacy & Security</h4>
                    <p>By continuing, you acknowledge that your information will be:</p>
                    <ul>
                        <li>Encrypted using industry-standard SSL/TLS protocols</li>
                        <li>Stored in compliance with <a href="https://gdpr.eu/what-is-gdpr/" target="_blank">GDPR</a> and <a href="https://oag.ca.gov/privacy/ccpa" target="_blank">CCPA</a> regulations</li>
                        <li>Protected by access controls and security monitoring</li>
                        <li>Never shared with third parties without explicit consent</li>
                    </ul>
                    <p class="privacy-reference">
                        For complete details, see our 
                        <a href="https://www.ftc.gov/business-guidance/privacy-security" target="_blank">Privacy Policy</a> 
                        and 
                        <a href="https://www.ftc.gov/tips-advice/business-center/guidance/complying-ftcs-health-breach-notification-rule" target="_blank">Security Standards</a>.
                    </p>
                </div>

                <button onclick="proceedToCredentials()" class="btn btn-primary" id="continueBtn">
                    <span id="continueBtnText">Continue to Credentials</span>
                    <span id="continueBtnLoader" class="hidden"><span class="spinner"></span> Processing...</span>
                </button>
            </div>

            <!-- Step 2: Credentials Collection -->
            <div id="step2" class="step hidden">
                <h2>Professional Credentials & Documentation</h2>
                <p class="step-description">Upload your certifications, credentials, and professional documentation. This information helps establish your credibility and enables faster verification.</p>
                
                <form id="credentialsForm" onsubmit="saveCredentials(event)">
                    <!-- Certifications Section -->
                    <div class="credentials-section">
                        <h3>Certifications & Training</h3>
                        <div class="form-group">
                            <label for="certifications">Certification Names *</label>
                            <textarea id="certifications" rows="3" placeholder="List your coaching certifications, training programs, and professional credentials (e.g., ICF Certified Professional Coach, NLP Practitioner, etc.)" required></textarea>
                            <small class="form-help">Separate multiple certifications with commas or new lines</small>
                        </div>
                        <div class="form-group">
                            <label for="certFiles">Upload Certification Documents</label>
                            <div class="file-upload-area" id="certUploadArea">
                                <input type="file" id="certFiles" multiple accept=".pdf,.jpg,.jpeg,.png" class="file-input">
                                <div class="file-upload-content">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    <p>Click to upload or drag and drop</p>
                                    <p class="file-hint">PDF, JPG, or PNG (Max 10MB each)</p>
                                </div>
                                <div id="certFileList" class="file-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Experience Section -->
                    <div class="credentials-section">
                        <h3>Coaching Experience</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="experienceYears">Years of Experience *</label>
                                <input type="number" id="experienceYears" min="0" max="50" placeholder="e.g., 5" required>
                            </div>
                            <div class="form-group">
                                <label for="experienceHours">Total Coaching Hours</label>
                                <input type="number" id="experienceHours" min="0" placeholder="e.g., 1000">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="specialization">Specialization / Niche *</label>
                            <input type="text" id="specialization" placeholder="e.g., Executive Coaching, Life Coaching, Career Development" required>
                        </div>
                        <div class="form-group">
                            <label for="experienceDetails">Experience Details</label>
                            <textarea id="experienceDetails" rows="4" placeholder="Describe your coaching background, notable clients, achievements, or results you've helped clients achieve"></textarea>
                        </div>
                    </div>

                    <!-- Professional Links Section -->
                    <div class="credentials-section">
                        <h3>Professional Presence</h3>
                        <div class="form-group">
                            <label for="website">Website URL</label>
                            <input type="url" id="website" placeholder="https://yourcoachingwebsite.com">
                            <small class="form-help">Your professional website or portfolio</small>
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn Profile</label>
                            <input type="url" id="linkedin" placeholder="https://linkedin.com/in/yourprofile">
                            <small class="form-help">Your LinkedIn professional profile URL</small>
                        </div>
                        <div class="form-group">
                            <label for="otherLinks">Other Professional Links</label>
                            <textarea id="otherLinks" rows="2" placeholder="Additional links (e.g., articles, publications, testimonials page, etc.)"></textarea>
                            <small class="form-help">Separate multiple URLs with commas or new lines</small>
                        </div>
                    </div>

                    <!-- Testimonials Section -->
                    <div class="credentials-section">
                        <h3>Client Testimonials & Reviews</h3>
                        <div class="form-group">
                            <label for="testimonials">Testimonials *</label>
                            <textarea id="testimonials" rows="5" placeholder="Paste client testimonials, reviews, or success stories. Include client names (with permission) and results when possible." required></textarea>
                            <small class="form-help">You can copy testimonials from review platforms or include written testimonials you've received</small>
                        </div>
                        <div class="form-group">
                            <label for="testimonialFiles">Upload Testimonial Documents</label>
                            <div class="file-upload-area" id="testimonialUploadArea">
                                <input type="file" id="testimonialFiles" multiple accept=".pdf,.jpg,.jpeg,.png" class="file-input">
                                <div class="file-upload-content">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                    <p>Upload testimonial screenshots or documents</p>
                                    <p class="file-hint">PDF, JPG, or PNG (Max 10MB each)</p>
                                </div>
                                <div id="testimonialFileList" class="file-list"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Verification Section -->
                    <div class="credentials-section">
                        <h3>Payment & Business Information</h3>
                        <div class="form-group">
                            <label for="paymentProof">Payment Method Verification</label>
                            <select id="paymentProof" required>
                                <option value="">Select payment method</option>
                                <option value="stripe">Stripe (Recommended)</option>
                                <option value="paypal">PayPal</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="other">Other</option>
                            </select>
                            <small class="form-help">Select your preferred payment method for receiving client payments</small>
                        </div>
                        <div class="form-group">
                            <label for="businessType">Business Type</label>
                            <select id="businessType">
                                <option value="">Select business type</option>
                                <option value="sole">Sole Proprietor</option>
                                <option value="llc">LLC</option>
                                <option value="corporation">Corporation</option>
                                <option value="partnership">Partnership</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button type="button" onclick="goBackToStep1()" class="btn btn-outline">← Back</button>
                        <button type="submit" class="btn btn-primary" id="saveCredentialsBtn">
                            <span id="saveCredentialsBtnText">Save Credentials & Continue</span>
                            <span id="saveCredentialsBtnLoader" class="hidden"><span class="spinner"></span> Saving...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 3: AI Verification Conversation -->
            <div id="step3" class="step hidden">
                <h2>AI Verification Conversation</h2>
                <p class="step-description">Our AI assistant will review your credentials and may ask additional questions to complete your verification.</p>
                
                <div id="chatContainer" class="chat-container">
                    <div id="chatMessages" class="chat-messages">
                        <!-- Messages will appear here -->
                    </div>
                    <div class="chat-input-container">
                        <input type="text" id="chatInput" placeholder="Type your message..." 
                               onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                        <button onclick="sendMessage()" class="btn btn-primary" id="sendBtn">
                            <span>Send</span>
                        </button>
                    </div>
                </div>

                <div id="credentialsSummary" class="credentials-summary hidden">
                    <h3>Credentials Collected</h3>
                    <div id="credentialsList"></div>
                    <button onclick="generateTrustSummary()" class="btn btn-primary">Generate Profile Summary</button>
                </div>
            </div>

            <!-- Step 4: Trust Summary -->
            <div id="step4" class="step hidden">
                <h2>Your Verification Profile Summary</h2>
                <div id="trustSummary" class="trust-summary-display">
                    <!-- Trust summary will appear here -->
                </div>
                <div class="actions">
                    <button onclick="regenerateSummary()" class="btn btn-outline">Regenerate Summary</button>
                    <button onclick="submitForReview()" class="btn btn-primary">Submit for Review</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentCoachId = null;
        let conversationStarted = false;
        let uploadedFiles = {
            certifications: [],
            testimonials: []
        };

        // File upload handlers
        function setupFileUpload(inputId, listId, fileType) {
            const input = document.getElementById(inputId);
            const area = document.getElementById(inputId.replace('Files', 'UploadArea'));
            const list = document.getElementById(listId);

            // Click handler
            area.addEventListener('click', () => input.click());

            // Drag and drop
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('drag-over');
            });

            area.addEventListener('dragleave', () => {
                area.classList.remove('drag-over');
            });

            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('drag-over');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files, input, list, fileType);
            });

            // File input change
            input.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                handleFiles(files, input, list, fileType);
            });
        }

        function handleFiles(files, input, list, fileType) {
            files.forEach(file => {
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`File ${file.name} exceeds 10MB limit`, 'error');
                    return;
                }

                uploadedFiles[fileType].push(file);
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <span class="file-name">${file.name}</span>
                    <span class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    <button type="button" class="file-remove" onclick="removeFile('${fileType}', '${file.name}')">×</button>
                `;
                list.appendChild(fileItem);
            });
        }

        function removeFile(fileType, fileName) {
            uploadedFiles[fileType] = uploadedFiles[fileType].filter(f => f.name !== fileName);
            const list = document.getElementById(fileType === 'certifications' ? 'certFileList' : 'testimonialFileList');
            const items = Array.from(list.children);
            const item = items.find(i => i.querySelector('.file-name').textContent === fileName);
            if (item) item.remove();
        }

        // Initialize file uploads
        setupFileUpload('certFiles', 'certFileList', 'certifications');
        setupFileUpload('testimonialFiles', 'testimonialFileList', 'testimonials');

        async function proceedToCredentials() {
            const name = document.getElementById('coachName').value;
            const email = document.getElementById('coachEmail').value;

            if (!name || !email) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const continueBtn = document.getElementById('continueBtn');
            const continueBtnText = document.getElementById('continueBtnText');
            const continueBtnLoader = document.getElementById('continueBtnLoader');
            
            continueBtn.disabled = true;
            continueBtnText.classList.add('hidden');
            continueBtnLoader.classList.remove('hidden');

            try {
                // Create coach
                const response = await fetch('/api/coaches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email })
                });

                const coach = await response.json();
                currentCoachId = coach.id;

                // Move to step 2
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error creating profile. Please try again.', 'error');
            } finally {
                continueBtn.disabled = false;
                continueBtnText.classList.remove('hidden');
                continueBtnLoader.classList.add('hidden');
            }
        }

        function goBackToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        async function saveCredentials(event) {
            event.preventDefault();

            if (!currentCoachId) {
                showToast('Session expired. Please start over.', 'error');
                return;
            }

            const saveBtn = document.getElementById('saveCredentialsBtn');
            const saveBtnText = document.getElementById('saveCredentialsBtnText');
            const saveBtnLoader = document.getElementById('saveCredentialsBtnLoader');
            
            saveBtn.disabled = true;
            saveBtnText.classList.add('hidden');
            saveBtnLoader.classList.remove('hidden');

            try {
                // Prepare credentials data
                const certifications = document.getElementById('certifications').value
                    .split(/[,\n]/)
                    .map(c => c.trim())
                    .filter(c => c.length > 0);

                const credentials = {
                    certifications: certifications,
                    experience: {
                        years: parseInt(document.getElementById('experienceYears').value) || 0,
                        hours: parseInt(document.getElementById('experienceHours').value) || 0,
                        details: document.getElementById('experienceDetails').value
                    },
                    specialization: document.getElementById('specialization').value,
                    website: document.getElementById('website').value || null,
                    linkedin: document.getElementById('linkedin').value || null,
                    otherLinks: document.getElementById('otherLinks').value.split(/[,\n]/).map(l => l.trim()).filter(l => l.length > 0),
                    testimonials: document.getElementById('testimonials').value.split(/\n\n/).filter(t => t.trim().length > 0),
                    paymentVerified: false,
                    paymentMethod: document.getElementById('paymentProof').value,
                    businessType: document.getElementById('businessType').value,
                    uploadedFiles: {
                        certifications: uploadedFiles.certifications.map(f => ({ name: f.name, size: f.size })),
                        testimonials: uploadedFiles.testimonials.map(f => ({ name: f.name, size: f.size }))
                    }
                };

                // Upload files if any
                if (uploadedFiles.certifications.length > 0 || uploadedFiles.testimonials.length > 0) {
                    const formData = new FormData();
                    formData.append('coachId', currentCoachId);
                    
                    uploadedFiles.certifications.forEach((file) => {
                        formData.append('certFiles', file);
                    });
                    
                    uploadedFiles.testimonials.forEach((file) => {
                        formData.append('testimonialFiles', file);
                    });

                    try {
                        const uploadResponse = await fetch(`/api/coaches/${currentCoachId}/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            console.warn('File upload failed, continuing without files');
                        }
                    } catch (uploadError) {
                        console.warn('File upload error:', uploadError);
                        // Continue even if upload fails
                    }
                }

                // Update coach with credentials
                const response = await fetch(`/api/coaches/${currentCoachId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ credentials })
                });

                if (!response.ok) {
                    throw new Error('Failed to save credentials');
                }

                const coach = await response.json();
                
                // Move to step 3 (AI conversation)
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step3').classList.remove('hidden');
                
                // Start AI conversation
                await startConversation();
                
                showToast('Credentials saved successfully!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showToast('Error saving credentials. Please try again.', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtnText.classList.remove('hidden');
                saveBtnLoader.classList.add('hidden');
            }
        }

        async function startConversation() {
            if (!currentCoachId || conversationStarted) return;
            conversationStarted = true;

            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();
                addMessage('assistant', data.message);
                updateCredentialsDisplay(data.coach.credentials || {});
            } catch (error) {
                console.error('Error:', error);
                showToast('Error starting conversation. Make sure OpenAI API key is configured.', 'error');
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            addMessage('user', message);
            input.value = '';
            
            input.disabled = true;
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn) {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="spinner"></span> Sending...';
            }
            
            const typingId = addMessage('assistant', '...');

            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });

                const data = await response.json();
                
                const typingEl = document.getElementById(`msg-${typingId}`);
                if (typingEl) typingEl.remove();

                if (data.error) {
                    addMessage('error', `Error: ${data.error}`);
                    showToast(data.error, 'error');
                } else {
                    addMessage('assistant', data.message);
                    updateCredentialsDisplay(data.coach.credentials || {});
                    
                    if (Object.keys(data.coach.credentials || {}).length > 0) {
                        document.getElementById('credentialsSummary').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                const typingEl = document.getElementById(`msg-${typingId}`);
                if (typingEl) typingEl.remove();
                addMessage('error', 'Error sending message. Please try again.');
                showToast('Unable to send message. Please check your connection.', 'error');
            } finally {
                input.disabled = false;
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<span>Send</span>';
                }
                input.focus();
            }
        }

        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${role}`;
            const id = Date.now();
            messageDiv.id = `msg-${id}`;
            
            let roleLabel = 'AI Assistant';
            if (role === 'user') roleLabel = 'You';
            else if (role === 'error' || role === 'system') roleLabel = 'System';
            
            messageDiv.innerHTML = `
                <div class="message-role">${roleLabel}</div>
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return id;
        }
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateCredentialsDisplay(credentials) {
            const listDiv = document.getElementById('credentialsList');
            let html = '<ul>';
            
            if (credentials.certifications && credentials.certifications.length > 0) {
                html += `<li>✅ Certifications: ${credentials.certifications.join(', ')}</li>`;
            }
            if (credentials.experience && credentials.experience.years) {
                html += `<li>✅ Experience: ${credentials.experience.years} years</li>`;
            }
            if (credentials.website) {
                html += `<li>✅ Website: <a href="${credentials.website}" target="_blank">${credentials.website}</a></li>`;
            }
            if (credentials.linkedin) {
                html += `<li>✅ LinkedIn: <a href="${credentials.linkedin}" target="_blank">View Profile</a></li>`;
            }
            if (credentials.testimonials && credentials.testimonials.length > 0) {
                html += `<li>✅ Testimonials: ${credentials.testimonials.length} collected</li>`;
            }
            if (credentials.paymentVerified) {
                html += `<li>✅ Payment Verified</li>`;
            }
            
            html += '</ul>';
            listDiv.innerHTML = html;
        }

        async function generateTrustSummary() {
            try {
                const response = await fetch(`/api/coaches/${currentCoachId}/generate-summary`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (data.error) {
                    showToast(`Error: ${data.error}`, 'error');
                } else {
                    showToast('Profile summary generated successfully!', 'success');
                    document.getElementById('trustSummary').innerHTML = 
                        `<div class="trust-summary-content">${data.summary.replace(/\n/g, '<br>')}</div>`;
                    
                    document.getElementById('step3').classList.add('hidden');
                    document.getElementById('step4').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error generating summary. Please try again.', 'error');
            }
        }

        async function regenerateSummary() {
            await generateTrustSummary();
        }

        async function submitForReview() {
            try {
                const response = await fetch(`/api/coaches/${currentCoachId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: 'pending_review' })
                });

                if (response.ok) {
                    showToast('✅ Profile submitted for review!', 'success');
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 1500);
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('Error submitting for review. Please try again.', 'error');
            }
        }
    </script>
</body>
</html>
